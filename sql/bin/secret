#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"

export INSTANCE_IP=$(gcloud sql instances describe ${INSTANCE} \
    --format='value(ipAddresses[0].ipAddress)')

export PGPASSWORD=$(<"${CONF_DIR}/app_password")

printf "postgres://${DB_USER}:${PGPASSWORD}@${INSTANCE_IP}:5432/${DB_NAME}?sslmode=verify-ca&sslrootcert=ca.pem&sslcert=client.pem&sslkey=client.key" | gcloud secrets create "${INSTANCE}-conn-str" --data-file=-


gcloud secrets create "${INSTANCE}-sslrootcert" --data-file="${CONF_DIR}/ca.pem"
gcloud secrets create "${INSTANCE}-sslcert" --data-file="${CONF_DIR}/client.pem"
gcloud secrets create "${INSTANCE}-sslkey" --data-file="${CONF_DIR}/client.key"

echo "Secrets created."